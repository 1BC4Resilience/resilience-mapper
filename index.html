<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="Resilience-mapper.css">

  <title>Geochart color example</title>
</head>

<body>
<script type='text/javascript' src='https://www.google.com/jsapi'></script>

<script type='text/javascript'>google.load('visualization', '1', {'packages': ['geochart','corechart', 'table']});
// Source: https://gist.github.com/patchypt/60cd3c0c723c2a3cf2921a276691bfd2
// Related source: https://gist.github.com/patchypt/baf4e4a2cf68b8327f93d02a52deb765

//<script type='text/javascript'>google.load('visualization', '1', {'packages': ['geochart']});

var people_reached = 0;
var total_projects = 0;
google.visualization.mapsApiKey = '57e92078e0fbd5006253e301';	

google.setOnLoadCallback(drawVisualization);

function drawVisualization() 
{ 
	var query = new google.visualization.Query('https://docs.google.com/spreadsheets/d/1iSLETQWyMa80y50VmRViXpfz4VF0NNGSLGcshaPvJ9A/edit#gid=0');
	//query.setQuery('select A,B');
        query.send(handleQueryResponseTR);
}

function handleQueryResponseTR(response) {
  	if (response.isError()) {
    		alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
    	return;
  }

var options = {
	 
	backgroundColor: {fill:'#FFFFFF',stroke:'#FFFFFF' ,strokeWidth:0 },
	colorAxis:  {colors: ['#b3cde0','#6497b1','#005b96','#03396c','#03396c','#011f4b','#011f4b','#011f4b',]},	
	backgroundColor: {fill:'#FFFFFF',stroke:'#FFFFFF' ,strokeWidth:0 },	
	datalessRegionColor: '#F5F0E7', 

	displayMode: 'regions', 
	enableRegionInteractivity: 'true', 
	resolution: 'countries',
	sizeAxis: {minValue: 1, maxValue:1,minSize:10,  maxSize: 10},
	region:'world',
	keepAspectRatio: true,
	/*
	width:800,
	height:600,
	*/
	legend: 'none',
	magnifyingGlass: {enable: true, zoomFactor: 7.5},
	tooltip: {isHtml:'true',textStyle: {color: '#444444'}, }	
};

var commitments_geochart_options = {
	 
	backgroundColor: {fill:'#FFFFFF',stroke:'#FFFFFF' ,strokeWidth:0 },
	colorAxis:  {colors: ['#ac9096','#ac9096','#ac9096','#a46e7a','#a46e7a','#a46e7a','#6e4959','#6e4959','#6e4959','#482a37',]},	
	backgroundColor: {fill:'#FFFFFF',stroke:'#FFFFFF' ,strokeWidth:0 },	
	datalessRegionColor: '#F5F0E7', 

	displayMode: 'markers', 
	enableRegionInteractivity: 'true', 
	resolution: 'countries',
	sizeAxis: {minValue: 1000000, maxValue:100000000,minSize:6,  maxSize: 40},
	region:'world',
	keepAspectRatio: true,
	legend: 'none',
	magnifyingGlass: {enable: true, zoomFactor: 7.5},
	tooltip: {isHtml:'true',textStyle: {color: '#444444'}, trigger: 'none',} //
};

/* moved inside Listener function
// moved whole chart_options section here so that the height values are updated dynamically based on # of projects
var paddingHeight = 80;
var rowHeight = 300;
var chartHeight = 350;


// moved whole chart_options section here so that the height values are updated dynamically based on # of projects
var chart_options = {
	width: '100%',
	height: chartHeight,
	chartArea: {
		//width: '90%',
		height: rowHeight
	},
	hAxis: {
	title: 'People reached',
	minValue: 0,
	logScale: true,
	},
	legend: 'none',
	series: { 0: {color: '#b3cde0'} },
	bar: {
		groupWidth: '80%'
	},
	vAxis: {
		textPosition: 'in',
		textStyle: { auraColor: 'none', fontSize: 14, }  //undocument option -- https://stackoverflow.com/questions/18230828/google-charts-remove-white-border-around-vaxis-textposition-in-text-on-bar-cha
	}
};
*/


var data = response.getDataTable();

var commitments_rows = data.getFilteredRows([{column: 8, value: 'Commitment'}]);
var existing_projects_data = new google.visualization.DataView(data);
existing_projects_data.hideRows(commitments_rows);

var existing_projects_rows = data.getFilteredRows([{column: 8, value: 'Existing project'}]);
var commitments_data = new google.visualization.DataView(data);
commitments_data.hideRows(existing_projects_rows);
commitments_data.setColumns([0,1]);   // can be replaced later with 'group' functionality below.

var country_summary_data = google.visualization.data.group(
	existing_projects_data,
	[0],
	[{'column': 1, 'aggregation': google.visualization.data.sum, 'type': 'number'}]
);

var view = new google.visualization.DataView(country_summary_data);

var commitments_view = new google.visualization.DataView(commitments_data);

/*
commitments_view.setColumns([0,1,{
	type:'string',
	label : 'dataname',
	calc: function (dt, row) {
		var dt1 = dt.getFormattedValue(row, 3)
		var dt2 = dt.getFormattedValue(row, 1)
		//var url = dt.getFormattedValue(row, 3)
		//var image = dt.getFormattedValue(row, 5)
       		return dt2 + ' people targeted'
	},
   	role: 'tooltip',
	p: {html: true}
}]);
*/


/*
view.setColumns([0,1,{
	type:'string',
	label : 'dataname',
	calc: function (dt, row) {
		var dt1 = dt.getFormattedValue(row, 1)
		var dt2 = dt.getFormattedValue(row, 2)
		var url = dt.getFormattedValue(row, 3)
		var image = dt.getFormattedValue(row, 5)
       		return dt1 + ' people reached'
	},
   	role: 'tooltip',
	p: {html: true}
}]);
*/

function setUpMap() {
	people_reached = getSum(existing_projects_data,1);
	total_projects = existing_projects_data.getNumberOfRows();

	people_targeted = getSum(commitments_data,1);
	total_commitments = commitments_data.getNumberOfRows();

	document.getElementById('summary_view').innerHTML = '<div class="summary-title">Global Total</div><div class="summary-heading">' + total_projects + '</div><div class="summary-detail">projects</div><div class="summary-heading">' + people_reached + '</div><div class="summary-detail">people reached</div>';

	document.getElementById('commitments_summary_view').innerHTML = '<div class="summary-title">Global Total</div><div class="summary-heading">' + total_commitments + '</div><div class="summary-detail">commitments</div><div class="summary-heading">' + people_targeted + '</div><div class="summary-detail">people targeted</div>';
	document.getElementById('chart_view').innerHTML = '';

}

function getSum(data, column) {
	var total = 0;
	for (i = 0; i < data.getNumberOfRows(); i++)
	total = total + data.getValue(i, column);
 	total = Math.round(total).toLocaleString();
	return total;
}

setUpMap();

var geochart = new google.visualization.GeoChart(document.getElementById('map_view'));
var barchart_view = new google.visualization.DataView(data);
var commitments_geochart = new google.visualization.GeoChart(document.getElementById('commitments_map_view'));


var barchart = new google.visualization.BarChart(document.getElementById('chart_view'));
//var tableChart = new google.visualization.Table(document.getElementById('table_view'));


google.visualization.events.addListener(commitments_geochart, 'select', function () {
	var commitments_selection = commitments_geochart.getSelection();
	if (commitments_selection.length > 0) {
		var commitment_list="";
		var x=0;
		var country_total=0;
		var country_project_total=0;

		//var commitments_name = commitments_data.getValue(commitments_selection[0].row, 0);

		var selected_commitment_row = commitments_data.getTableRowIndex(commitments_selection[0].row);


		describeCommitment(selected_commitment_row);
		//var projects = data.getFilteredRows([{column: 2, value: country_name}]);
	}
});


function describeCommitment(commitmentRow) {
var project_info_list = 'test';

project_info_list = '<div class="project-title">' + data.getValue(commitmentRow,3) + '</div>' +
		'<div class="line_container"><div class="project-detail-header">Target:</div><div class="project-detail-content">' + data.getValue(commitmentRow,1).toLocaleString() + '</div></div>' +
		'<div class="line_container"><div class="project-detail-header">Org:</div><div class="project-detail-content"><a href="' + data.getValue(commitmentRow,6) +'" target="_blank">' + data.getValue(commitmentRow,4) + '</a></div></div>' +
		'<div class="line_container"><div class="project-detail-header">Description:</div><div class="project-detail-content">' + data.getValue(commitmentRow,7) + '</div></div>' +
		'<div class="line_container"><div class="project-detail-header">Contact:</div><div class="project-detail-content">' + data.getValue(commitmentRow,5) + '</div></div>' +

		'<div class="line_container"><div class="project-detail-header">Source:</div><div class="project-detail-content">' + data.getValue(commitmentRow,9) + '</div></div>';

document.getElementById('commitment_detail_view').innerHTML = project_info_list;
document.getElementById('commitment_photo_view').innerHTML = '<div><img class="commitment_photo" src="'+ data.getValue(commitmentRow,10) + '"></div>';

}

	 
google.visualization.events.addListener(geochart, 'select', function () {
	var country_selection = geochart.getSelection();
	if (country_selection.length > 0) {
	//window.open(data.getValue(country_selection[0].row, 6));
		var project_list="";
		var x=0;
		var country_total=0;
		var country_project_total=0;

		var country_name = country_summary_data.getValue(country_selection[0].row, 0);

		var projects = data.getFilteredRows([{column: 2, value: country_name}]);

		//var barchart_view = new google.visualization.DataView(data);
		barchart_view.setRows(projects);
		barchart_view.setColumns([3,1]);

		//tableChart.draw(barchart_view, null);

		for (x in projects) {
			/*
			project_list += '<div class="project-title">' + data.getValue(projects[x],3) + '</div>' +
					'<div class="project-detail-header">Org:</div><div class="project-detail-content">' + data.getValue(projects[x],4) + '</div>' +
					'<div class="project-detail-header">People reached:</div><div class="project-detail-content">' + data.getValue(projects[x],1) + '</div>' +
					'<div class="project-detail-header">Description:</div><div class="project-detail-content">' + data.getValue(projects[x],7) + '</div>' +

					'<div class="project-detail-header">Source:</div><div class="project-detail-content">' + data.getValue(projects[x],9) + '</div>' 
			;
			*/

			country_total += data.getValue(projects[x],1);
			country_project_total = country_project_total + 1;
		}
		document.getElementById('projects_view').innerHTML = '<div class="projects-heading">Projects</div>' + project_list;
		document.getElementById('project_detail_view').innerHTML = '';

		// moved whole chart_options section here so that the height values are updated dynamically based on # of projects
        	var paddingHeight = 80;
		var chartHeight = 350;


		var rowHeight = country_project_total * 26;
		if (country_project_total > 3) {
			chartHeight = rowHeight + paddingHeight;
		} else {
			chartHeight = (4 * 26) + paddingHeight;
		}
		
		/* debugging code
		barchart.draw(barchart_view, chart_options);
		alert('Here');
		//alert('chartHeight1 = ' + barchart.getOption('height'));

		barchart.setOption('height', chartHeight);
		barchart.setOption('chartArea.height', rowHeight);
		//alert('chartHeight2 = ' + barchart.getOption('height'));
		barchart.draw();
		*/

		// moved whole chart_options section here so that the height values are updated dynamically based on # of projects
		// code based on https://stackoverflow.com/questions/41106098/how-to-set-google-chart-height-based-on-number-of-rows
		// additional info: https://groups.google.com/forum/#!topic/google-visualization-api/VcgHvrCrCNM
		var chart_options = {
			width: '100%',
			height: chartHeight,
			chartArea: {
				width: '100%',
				height: rowHeight
			},
			hAxis: {
			title: 'People reached',
			minValue: 0,
			logScale: true,
			},
			legend: 'none',
			series: { 0: {color: '#b3cde0'} },
			bar: {
				groupWidth: '80%'
			},
			tooltip: {trigger: 'none'},
			vAxis: {
				textPosition: 'in',
				textStyle: { auraColor: 'none', fontSize: 14, }  //undocument option -- https://stackoverflow.com/questions/18230828/google-charts-remove-white-border-around-vaxis-textposition-in-text-on-bar-cha
			}
		};


		barchart.draw(barchart_view, chart_options);
		country_total = country_total.toLocaleString();
		document.getElementById('summary_view').innerHTML = '<div class="summary-title">' + country_name + '</div><div class="summary-heading">' + country_project_total + '</div><div class="summary-detail">projects</div><div class="summary-heading">' + country_total + '</div><div class="summary-detail">people reached</div>';

		if (country_project_total == 1) {
			//alert('Here');
			describeProject(barchart_view.getTableRowIndex(0));
		} else {
			document.getElementById('project_detail_view').innerHTML = '<div class="advice">Click on projects listed in the chart on the left to see more details.</div>';
		}

	}
	else {
		window.location.reload(true);
		//setUpMap();
	}
});

/*
google.visualization.events.addListener(barchart, 'select', function () {
	var project_selection = barchart.getSelection();
	if (project_selection.length > 0) {
		alert('Project selected');
	}
	
});
*/


/* alternative is to check for label styles using text-anchor="start" and then match back from there
$('#start').click(function() {
   alert(data.getValue(this.cellIndex,0));
});

per https://stackoverflow.com/questions/7996702/how-to-add-onclick-event-to-gauge-of-google-chart
*/


/* Based on code from https://stackoverflow.com/questions/23192794/attach-event-handler-to-column-chart-in-google-charts  */
google.visualization.events.addListener(barchart, 'click', function(e) {
	//alert(e.targetID);
	var match = e.targetID.match(/vAxis#\d#label#(\d{1,3})/);		//matches for up to 3 digit numbers of projects
	if (match != null && match.length) {
		var rowIndex = parseInt(match[1],10);
		// get the value from column 0 in the clicked row
		var label = barchart_view.getValue(rowIndex, 0);
		describeProject(barchart_view.getTableRowIndex(rowIndex));
	} else {
		var bar_match = e.targetID.match(/bar#\d#(\d{1,3})/);
		var rowIndex = parseInt(bar_match[1],10);
		// get the value from column 0 in the clicked row
		var label = barchart_view.getValue(rowIndex, 0);
		describeProject(barchart_view.getTableRowIndex(rowIndex));
	}
/*
        var new_view = new google.visualization.DataView(barchart_view);
        new_view.setColumns([0, 1, {
            type: 'string',
            role: 'style',
            calc: function (dt, i) {
                return (i == rowIndex) ? 'color: yellow' : null;
            }
        }]);

        barchart.draw(new_view, chart_options);
*/

});

function describeProject(projectRow) {
var project_info_list = 'test';

project_info_list = '<div class="project-title">' + data.getValue(projectRow,3) + '</div>' +
		'<div class="line_container"><div class="project-detail-header">Org:</div><div class="project-detail-content"><a href="' + data.getValue(projectRow,6) +'" target="_blank">' + data.getValue(projectRow,4) + '</a></div></div>' +
		'<div class="line_container"><div class="project-detail-header">Description:</div><div class="project-detail-content">' + data.getValue(projectRow,7) + '</div></div>' +
		'<div class="line_container"><div class="project-detail-header">Contact:</div><div class="project-detail-content">' + data.getValue(projectRow,5) + '</div></div>' +

		'<div class="line_container"><div class="project-detail-header">Source:</div><div class="project-detail-content">' + data.getValue(projectRow,9) + '</div></div>';

document.getElementById('project_detail_view').innerHTML = project_info_list;

}

geochart.draw(view, options);
document.getElementById('projects_view').innerHTML = '<div class="advice">Click on a country in the map above to see details on projects in each country.</div>';
commitments_geochart.draw(commitments_view, commitments_geochart_options);
document.getElementById('commitment_detail_view').innerHTML = '<div class="advice">Click on a circle in the map above to see details on each of the commitments.</div>';
//tableChart.draw(projects, null);

function resizeChart () {
    	geochart.draw(view, options);
	commitments_geochart.draw(commitments_view, commitments_geochart_options);
	barchart.draw(barchart_view, chart_options);
}
if (document.addEventListener) {
	window.addEventListener('resize', resizeChart);
}
else if (document.attachEvent) {
	window.attachEvent('onresize', resizeChart);
}
else {
	window.resize = resizeChart;
}

}


function openMap(evt, mapName) {
    // Declare all variables
    var i, tabcontent, tablinks;

    // Get all elements with class="tabcontent" and hide them
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }

    // Get all elements with class="tablinks" and remove the class "active"
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }

    // Show the current tab, and add an "active" class to the button that opened the tab
    document.getElementById(mapName).style.display = "block";
    evt.currentTarget.className += " active";
}

window.onload = function () {
	startTab();
};

function startTab() {
	document.getElementById("defaultOpen").click();
}

</script>


<!-- Tab links -->
<div class="tab">
  <button class="tablinks"  id="defaultOpen" onclick="openMap(event, 'Existing_contributions')">Existing contributions</button>
  <button class="tablinks" onclick="openMap(event, '1BC_commitments')">1BC commitments</button>
  <button class="tablinks" onclick="openMap(event, 'Partnering_opportunities')">Partnering opportunities</button>
</div>

<!-- Tab content -->
<div id="Existing_contributions" class="tabcontent">
<h3>Existing resilience contributions</h3>
<div id='map_view'></div>
<div id='summary_view'></div>
<div id='projects_view'></div>
<div id='project_details_container'>
<div id='chart_view'></div>
<div id='project_detail_view'></div>
</div>
</div>

<div id="1BC_commitments" class="tabcontent">
  <h3>1BC commitments</h3>
  <p>Current commitments toward 1BC global goal.</p> 
<div id='commitments_map_view'></div>
<div id='commitments_summary_view'></div>
<div id='commitment_detail_container'>
<div id='commitment_detail_view'></div>
<div id='commitment_photo_view'></div>
</div>
</div>

<div id="Partnering_opportunities" class="tabcontent">
  <h3>Partnering opportunities</h3>
  <p><i>In development coming soon.</i></p>
</div>


<div id='table_view'></div>
</body>
</html>
